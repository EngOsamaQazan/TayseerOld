# معالج فاتورة التوريد وسير الموافقات

## استخدام نظام الإشعارات الموجود

النظام يضم **نظام إشعارات جاهز** (كان معطّلاً أو غير مستخدم في بعض الشاشات). يُستحسن استخدامه أو التطوير عليه لأي إشعارات خاصة بأوامر الشراء.

- **الواجهة:** جرس الإشعارات في الهيدر (قائمة منسدلة `#notifDropdown`) — تعرض آخر 10 إشعارات وعدد غير المقروءة وزر "تمييز الجميع كمقروء".
- **الجدول:** `os_notification` (الموديل: `backend\modules\notification\models\Notification`).
- **المكوّن:** `Yii::$app->notifications` (`common\components\notificationComponent`):
  - **`add($href, $type, $title_html, $body_html, $sender_id, $recipient_id)`** — إرسال إشعار لمستخدم واحد (معرف المستخدم `recipient_id`).
  - **`sendByRule($rule, $href, $type, $title_html, $body_html, $sender_id)`** — إرسال لكل من يحمل أحد الأدوار في `$rule` (مصفوفة أسماء أدوار، مثل `['Manager']` أو `['موظف مبيعات']`). يستخدم جدول `auth_assignment` (ـ`item_name` = اسم الدور).
  - **`setReaded($id)`** — تمييز إشعار واحد كمقروء (يُستدعى عادة عند الدخول للصفحة المرتبطة مع تمرير `notificationID`).
- **الثوابت:** `Notification::GENERAL` للنوع العام.

**مثال من النظام الحالي (عقود / عملاء):**
```php
use backend\modules\notification\models\Notification;

Yii::$app->notifications->sendByRule(
    ['Manager'],
    'contracts/update?id=' . $model->id,
    Notification::GENERAL,
    'عنوان الإشعار',
    'نص الإشعار',
    Yii::$app->user->id
);
```

عند فتح الرابط من الإشعار يمكن تمييزه كمقروء: `actionView($id, $notificationID = 0)` ثم عند وجود `$notificationID` استدعاء `Yii::$app->notifications->setReaded($notificationID)`.

---

## 1. زر "فاتورة جديدة" ومعالج (Wizard) للمورد

**المنطق المطلوب:**
- المورد يضغط على "فاتورة جديدة" فيظهر له معالج خطوات.
- **الخطوة 1:** اختيار/إضافة أصناف (بحث عن صنف موجود، أو إضافة صنف جديد من نفس المعالج).
- **الخطوة 2:** تعبئة بيانات الفاتورة كاملة + السعر الفردي لكل صنف + الباركود الرئيسي + الكمية (حبة).
- **الخطوة 3:** إدخال سيريالات الأجهزة.
- **الخطوة 4:** مراجعة وإنهاء العملية.

**التنفيذ المقترح:**
- إضافة action في `InventoryInvoicesController` مثل `actionCreateWizard()` (موجود هيكلياً) وصفحة المعالج.
- استدعاء موجود لـ search items و quick-add-item من واجهة المخزون.
- عند الانتهاء: حفظ الفاتورة + البنود + تحديث الكميات + تسجيل الحركات (نفس منطق `actionCreate()` الحالي)، مع تعيين الحالة الأولى للموافقة (مثلاً `pending_reception`).

---

## 2. إشعار موظف المبيعات (الفرع) والموافقة/الرفض

**المنطق المطلوب:**
- عند إضافة أمر الشراء يصل لموظف المبيعات المسؤول عن الفرع إشعاراً.
- يقوم بتأكيد البضاعة المستلمة (موافقة أو رفض).
- في حال الموافقة: تثبيت الفاتورة.
- في حال الرفض: يمكنه تعديل الأجهزة/السيريالات/الأصناف ثم تثبيتها.

**استخدام نظام الإشعارات الحالي:**
- بعد حفظ الفاتورة من المعالج (بحالة مثل `pending_reception`):
  - إما **`sendByRule(['موظف مبيعات'])`** إذا وُجد دور بهذا الاسم في `auth_assignment`،
  - أو **`add(..., $recipient_id)`** إذا كان لديك جدول/منطق يربط الفرع بموظف مبيعات واحد (تحصل على `recipient_id` وتستدعي `add`).
- **الرابط (href):** مثلاً `inventoryInvoices/inventory-invoices/view?id=XXX` أو صفحة موافقة مخصصة مع `notificationID` لتمييز الإشعار كمقروء عند الدخول.
- **العنوان/النص:** مثل "فاتورة توريد جديدة #XX بانتظار تأكيد الاستلام".

**ما يلزم إضافته (خارج الإشعارات):**
- ربط الفروع بموظف مبيعات (صلاحية أو جدول branch_sales_user) إن لم يكن موجوداً.
- حالات للفاتورة: مثلاً `pending_reception` → عند الحفظ من المعالج.
- action للموظف: `actionApproveReception($id)` و `actionRejectReception($id)` مع إمكانية تعديل البنود/السيريالات ثم تحديث الحالة إلى `approved_sales`.

---

## 3. إشعار المدير والموافقة النهائية

**المنطق المطلوب:**
- بعد استلام موظف المبيعات يصل إشعار للمدير بتثبيت فاتورة جديدة.
- المدير يتأكد منها وله صلاحية إرجاع الفاتورة لعدم الموافقة على السعر وتعديله ثم التثبيت النهائي.

**استخدام نظام الإشعارات الحالي:**
- عند انتقال الفاتورة إلى `approved_sales` استدعاء:
  ```php
  Yii::$app->notifications->sendByRule(
      ['Manager'],
      'inventoryInvoices/inventory-invoices/view?id=' . $invoiceId,
      Notification::GENERAL,
      'فاتورة توريد #' . $invoiceId . ' بانتظار الموافقة النهائية',
      'تم تأكيد الاستلام من موظف المبيعات. مراجعة السعر والموافقة النهائية.',
      $senderId
  );
  ```
- **الرابط:** نفس صفحة عرض الفاتورة أو صفحة "موافقة مدير" مع دعم `notificationID` واستدعاء `setReaded($notificationID)` عند الدخول.
- حالات: `approved_sales` → `pending_manager` → `approved_final` أو رفض وتعديل ثم إعادة إرسال.

---

## 4. صلاحيات المدير: تعديل أسعار الأصناف وخصم على الفاتورة

**المنطق المطلوب:**
- للمدير تعديل أسعار الأصناف صنفاً صنفاً.
- إضافة خصم على الفاتورة ككل (مبلغ أو نسبة).

**ما يلزم:**
- حقل اختياري في جدول الفاتورة للخصم: مثلاً `discount_amount` أو `discount_percent`، وإعادة حساب `total_amount`.
- واجهة تعديل الفاتورة للمدير تعرض البنود مع السعر القابل للتعديل وحقل الخصم الإجمالي.

---

## سير الحالات المقترح (للتطوير لاحقاً)

```
إنشاء من المعالج → pending_reception
    ↓ (إشعار عبر نظام الإشعارات الحالي لموظف المبيعات)
    ↓ (موظف مبيعات يوافق) → approved_sales
    ↓ (موظف مبيعات يرفض → تعديل → يوافق) → approved_sales
    ↓ (إشعار عبر sendByRule(['Manager']) للمدير)
    ↓ (مدير يوافق) → approved_final
    ↓ (مدير يرفض / يعدل السعر ثم يوافق) → approved_final
```

- عند `approved_final` يمكن تطبيق نفس منطق التحديث الحالي للكميات والحركات إن لم يكن مُطبّقاً عند الموافقة الأولى.

---

## ملخص

- **الإشعارات:** استخدام جدول `os_notification` ومكوّن `Yii::$app->notifications` (ـ`add` أو `sendByRule`) وربط الرابط بصفحة عرض/موافقة الفاتورة مع `notificationID` وـ`setReaded` — دون إنشاء جدول إشعارات جديد.
- **الواجهة:** جرس الإشعارات في الهيدر (`#notifDropdown`) يعرض الإشعارات تلقائياً بعد إضافتها؛ يمكن تفعيله أو تطويره إذا كان معطّلاً.
- تنفيذ المعالج (الخطوات 1–4 من الطلب الأول) أولاً، ثم إرسال الإشعارات عند تغيير حالة الفاتورة باستخدام نفس النظام أعلاه.
