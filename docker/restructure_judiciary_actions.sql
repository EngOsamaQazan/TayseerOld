-- ==========================================================================
-- إعادة هيكلة الإجراءات القضائية - من 87 إجراء إلى 81 إجراء موحّد
-- ==========================================================================
-- تشمل: إضافة نوع "معلومه وارده"، حذف 7 إجراءات، دمج 8 مكررات،
--        إعادة تسمية، إعادة تصنيف، إضافة 9 إجراءات جديدة، إعادة ترقيم
-- ==========================================================================

SET FOREIGN_KEY_CHECKS = 0;
SET @OLD_SQL_MODE = @@SQL_MODE;
SET SQL_MODE = 'NO_AUTO_VALUE_ON_ZERO';

-- ==========================================================================
-- المرحلة 1: إضافة 'incoming_info' (معلومه وارده) إلى قائمة أنواع الإجراءات
-- ==========================================================================
ALTER TABLE os_judiciary_actions
MODIFY COLUMN action_type ENUM('request', 'court_letter', 'judge_decision', 'party_petition', 'incoming_info')
NOT NULL DEFAULT 'request';

-- ==========================================================================
-- المرحلة 2: نقل مراجع الإجراءات المحذوفة إلى بدائلها
-- ==========================================================================

-- طباعة مذكرة (16, 5 سجلات) → مذكرة إحضار (9)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 9 WHERE judiciary_actions_id = 16;

-- تحريك قضية (24, 320 سجل) → مثابره على التنفيذ منعاً للترك (61)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 61 WHERE judiciary_actions_id = 24;

-- اسقاط الدعوى مكرر (33, 36 سجل) → اسقاط الدعوى الأصلي (15)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 15 WHERE judiciary_actions_id = 33;

-- نُفِّذت حبسا (35, 51 سجل) → أمر حبس لعدم الدفع (48)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 48 WHERE judiciary_actions_id = 35;

-- منتهي (40, 3 سجلات) → حذف من سجلات القضايا
DELETE FROM os_judiciary_customers_actions WHERE judiciary_actions_id = 40;

-- متوفي (41, 38 سجل) → حذف من سجلات القضايا
DELETE FROM os_judiciary_customers_actions WHERE judiciary_actions_id = 41;

-- اسناد الاخطار التنفيذي (47, 46 سجل) → طلب اعادة تبليغ (39)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 39 WHERE judiciary_actions_id = 47;

-- ==========================================================================
-- المرحلة 3: نقل مراجع الإجراءات المكررة ودمجها
-- ==========================================================================

-- طلب حسم من الراتب (45, 295 سجل) → طلب حسم راتب محكوم عليه (8)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 8 WHERE judiciary_actions_id = 45;

-- طلب حجز مركبه (46, 93 سجل) → ط.حجز مركبة (23)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 23 WHERE judiciary_actions_id = 46;

-- اخطار كفيل استئناف مكرر (77, 1 سجل) → إخطار كفيل إستئناف (52)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 52 WHERE judiciary_actions_id = 77;

-- مذكرة رفع اشارة منع سفر مكرر (79, 2 سجل) → مذكرة رفع اشارة منع سفر (50)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 50 WHERE judiciary_actions_id = 79;

-- حجز مكافأة نهايه الخدمه (82, 75 سجل) → طلب حجز على المكافئة (62)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 62 WHERE judiciary_actions_id = 82;

-- طلب ادخال طرف بالقضيه مكرر (84, 5 سجلات) → طلب ادخال طرف بالقضيه (80)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 80 WHERE judiciary_actions_id = 84;

-- حجز منشاه مكرر (85, 1 سجل) → طلب حجز منشاه (83)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 83 WHERE judiciary_actions_id = 85;

-- كتاب القاء الحجز ع الاموال لدى البنوك مكرر (86, 26 سجل) → كتاب إلقاء الحجز على أموال لدى البنوك (59)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 59 WHERE judiciary_actions_id = 86;

-- ==========================================================================
-- المرحلة 4: حذف الإجراءات المحذوفة والمدمجة من جدول الإجراءات
-- ==========================================================================
DELETE FROM os_judiciary_actions WHERE id IN (16, 24, 33, 35, 40, 41, 47, 45, 46, 77, 79, 82, 84, 85, 86);

-- ==========================================================================
-- المرحلة 5: إعادة تسمية الإجراءات
-- ==========================================================================
UPDATE os_judiciary_actions SET name = 'مذكرة احضار صادره على محكوم عليه' WHERE id = 9;
UPDATE os_judiciary_actions SET name = 'ط.ب.استئناف' WHERE id = 26;
UPDATE os_judiciary_actions SET name = 'كتاب كف الطلب عن مركبة' WHERE id = 42;
UPDATE os_judiciary_actions SET name = 'كتاب رفع اشارة الحجز عن مركبة' WHERE id = 43;
UPDATE os_judiciary_actions SET name = 'كتاب حجز على الأموال المنقوله وغير المنقوله' WHERE id = 72;
UPDATE os_judiciary_actions SET name = 'طلب حجز مكافأة نهاية خدمة' WHERE id = 62;
UPDATE os_judiciary_actions SET name = 'كتاب رفع اشارة الحسم' WHERE id = 54;
UPDATE os_judiciary_actions SET name = 'طلب طرح مركبة للبيع بالمزاد العلني' WHERE id = 69;
UPDATE os_judiciary_actions SET name = 'طلب مثابرة منعا للترك' WHERE id = 61;
UPDATE os_judiciary_actions SET name = 'استدعاء تجديد الدعوى' WHERE id = 87;
UPDATE os_judiciary_actions SET name = 'متروكة' WHERE id = 65;
UPDATE os_judiciary_actions SET name = 'طلب رد المبالغ المدفوعة' WHERE id = 55;
UPDATE os_judiciary_actions SET name = 'طلب اخطار في مكان العمل' WHERE id = 67;
UPDATE os_judiciary_actions SET name = 'طلب تبليغ الكتروني' WHERE id = 68;
UPDATE os_judiciary_actions SET name = 'مذكرة تبليغ موعد جلسة تنفيذية' WHERE id = 51;
UPDATE os_judiciary_actions SET name = 'طلب ضبط مركبه' WHERE id = 44;

-- تنظيف المسافات الزائدة وأحرف Tab من جميع الأسماء
UPDATE os_judiciary_actions SET name = TRIM(BOTH '\t' FROM TRIM(name));

-- ==========================================================================
-- المرحلة 6: إعادة تصنيف أنواع الإجراءات
-- ==========================================================================

-- تحويل إلى "معلومه وارده" (incoming_info)
UPDATE os_judiciary_actions SET action_type = 'incoming_info' WHERE id IN (
    1,  -- تجهيز قضيه
    2,  -- امر قبض
    3,  -- دفع الرسم
    4,  -- تسجيل قضيه
    10, -- معمم لدى ادارة التنفيذ القضائي
    13, -- جاري الحسم
    17, -- نشر
    25, -- عدم ورود اقتطاعات
    32, -- مدفوع
    34, -- محبوس على ذمة قضايا اخرى
    88  -- الراتب لا يسمح
);

-- تحويل إلى "كتاب صادر" (court_letter)
UPDATE os_judiciary_actions SET action_type = 'court_letter' WHERE id IN (
    11, -- كف طلب صادر عن المحكوم عليه (كان party_petition)
    18  -- تبليغ اخبار حبس (كان request)
);

-- تحويل إلى "طلب" (request)
UPDATE os_judiciary_actions SET action_type = 'request' WHERE id IN (
    15, -- اسقاط الدعوى (كان judge_decision)
    19  -- مصالحة (كان judge_decision)
);

-- تحويل إلى "استدعاء" (party_petition)
UPDATE os_judiciary_actions SET action_type = 'party_petition' WHERE id IN (
    55, -- طلب رد المبالغ المدفوعة (كان request)
    80, -- طلب ادخال طرف بالقضيه (كان request)
    87  -- استدعاء تجديد الدعوى (كان request)
);

-- ==========================================================================
-- المرحلة 7: إضافة الإجراءات الجديدة (9 إجراءات)
-- ==========================================================================
INSERT INTO os_judiciary_actions (id, name, action_type) VALUES
(91, 'كتاب استفسار عن الحسابات البنكية', 'court_letter'),
(92, 'كتاب استفسار لادارة الترخيص', 'court_letter'),
(93, 'كتاب القاء حجز على سجل تجاري', 'court_letter'),
(94, 'طلب تحويل رصيد محجوز لدى الحساب البنكي', 'request'),
(95, 'كتاب رفع اشارة الحجز عن سجل تجاري', 'court_letter'),
(96, 'كتاب رفع اشارة الحجز عن حساب بنكي', 'court_letter'),
(97, 'طلب استفسار عدم ورود اقتطاع', 'request'),
(98, 'طلب وضع اليد على معرض تجاري محجوز', 'request'),
(99, 'طلب تحديد اقتطاع', 'request');

-- ==========================================================================
-- المرحلة 8: إعادة ترقيم جميع الإجراءات من 1 إلى 81
-- ==========================================================================

-- الخطوة 8أ: نقل جميع IDs الحالية إلى نطاق مؤقت (+10000)
UPDATE os_judiciary_actions SET id = id + 10000;
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = judiciary_actions_id + 10000;

-- الخطوة 8ب: إنشاء جدول التعيين المؤقت
DROP TABLE IF EXISTS _id_map;
CREATE TABLE _id_map (old_id INT PRIMARY KEY, new_id INT NOT NULL);

INSERT INTO _id_map (old_id, new_id) VALUES
-- القائمة الكاملة: old_id (الأصلي قبل +10000) → new_id (الترقيم الجديد)
(1, 1),   -- تجهيز قضيه
(2, 2),   -- امر قبض
(3, 3),   -- دفع الرسم
(4, 4),   -- تسجيل قضيه
(5, 5),   -- اخطار صادر عن دائرة التنفيذ
(6, 6),   -- إعادة تبيلغ
(7, 7),   -- طلب حبس وجلب محكوم عليه
(8, 8),   -- طلب حسم راتب محكوم عليه
(9, 9),   -- مذكرة احضار صادره على محكوم عليه
(10, 10), -- معمم لدى ادارة التنفيذ القضائي
(11, 11), -- كف طلب صادر عن المحكوم عليه
(12, 12), -- مذكرة منع سفر
(13, 13), -- جاري الحسم
(14, 14), -- استئناف
(15, 15), -- اسقاط الدعوى
(17, 16), -- نشر
(18, 17), -- تبليغ اخبار حبس
(19, 18), -- مصالحة
(20, 19), -- طلب نشر
(21, 20), -- تسوية محكمة
(22, 21), -- كتاب حسم من الراتب
(23, 22), -- ط.حجز مركبة
(25, 23), -- عدم ورود اقتطاعات
(26, 24), -- ط.ب.استئناف
(27, 25), -- كتاب وضع اشارة الحجز على مركبة
(28, 26), -- كتاب ضبط مركبة
(29, 27), -- انكار توقيع
(30, 28), -- ابطال التبليغات
(31, 29), -- ابطال سند
(32, 30), -- مدفوع
(34, 31), -- محبوس على ذمة قضايا اخرى
(36, 32), -- نقل تلقائي
(39, 33), -- طلب اعادة تبليغ المحكوم عليه
(50, 34), -- مذكرة رفع اشارة منع سفر
(42, 35), -- كتاب كف الطلب عن مركبة
(44, 36), -- طلب ضبط مركبه
(43, 37), -- كتاب رفع اشارة الحجز عن مركبة
(91, 38), -- كتاب استفسار عن الحسابات البنكية [جديد]
(92, 39), -- كتاب استفسار لادارة الترخيص [جديد]
(59, 40), -- كتاب إلقاء الحجز على أموال لدى البنوك
(93, 41), -- كتاب القاء حجز على سجل تجاري [جديد]
(94, 42), -- طلب تحويل رصيد محجوز لدى الحساب البنكي [جديد]
(95, 43), -- كتاب رفع اشارة الحجز عن سجل تجاري [جديد]
(72, 44), -- كتاب حجز على الأموال المنقوله وغير المنقوله
(96, 45), -- كتاب رفع اشارة الحجز عن حساب بنكي [جديد]
(62, 46), -- طلب حجز مكافأة نهاية خدمة
(97, 47), -- طلب استفسار عدم ورود اقتطاع [جديد]
(54, 48), -- كتاب رفع اشارة الحسم
(69, 49), -- طلب طرح مركبة للبيع بالمزاد العلني
(61, 50), -- طلب مثابرة منعا للترك
(87, 51), -- استدعاء تجديد الدعوى
(65, 52), -- متروكة
(98, 53), -- طلب وضع اليد على معرض تجاري محجوز [جديد]
(99, 54), -- طلب تحديد اقتطاع [جديد]
(55, 55), -- طلب رد المبالغ المدفوعة
(48, 56), -- أمر حبس لعدم الدفع
(49, 57), -- مذكرة إفراج للموقوفين
(51, 58), -- مذكرة تبليغ موعد جلسة تنفيذية
(52, 59), -- إخطار كفيل إستئناف صادر عن دائرة التنفيذ
(53, 60), -- مثابره بعد الحبس
(56, 61), -- كتاب استفسار لعدم ورود اقتطاع
(57, 62), -- طلب رفع اشارة منع سفر
(58, 63), -- طلب كف طلب عن المحكوم عليه
(60, 64), -- طلب حجز الاموال المنقوله وغير المنقوله
(63, 65), -- كتاب حجز على المكافئه
(64, 66), -- اخطار خاص بتجديد التنفيذ
(66, 67), -- حجز حصة شريك
(67, 68), -- طلب اخطار في مكان العمل
(68, 69), -- طلب تبليغ الكتروني
(70, 70), -- طلب تخمين المركبه
(71, 71), -- اعلان بيع مركبه بالمزاد العلني
(73, 72), -- طلب حجز حساب بنكي
(75, 73), -- طلب حجز راتب
(76, 74), -- كتاب إخطار بالحجز على أموال / مستحقات المدين المنقولة لدى الغير
(78, 75), -- كتاب كف الطلب عن شخص
(80, 76), -- طلب ادخال طرف بالقضيه
(81, 77), -- طلب اشراك اقتطاع
(83, 78), -- طلب حجز منشاه
(88, 79), -- الراتب لا يسمح
(89, 80), -- طلب رفع حسم
(90, 81); -- كتاب مخاطبة رسمية - جهات حكومية

-- الخطوة 8ج: تطبيق التعيين على جدول الإجراءات
UPDATE os_judiciary_actions a
JOIN _id_map m ON a.id = m.old_id + 10000
SET a.id = m.new_id;

-- الخطوة 8د: تطبيق التعيين على جدول إجراءات العملاء
UPDATE os_judiciary_customers_actions c
JOIN _id_map m ON c.judiciary_actions_id = m.old_id + 10000
SET c.judiciary_actions_id = m.new_id;

-- الخطوة 8هـ: تنظيف أي مراجع يتيمة (احتياطياً)
DELETE FROM os_judiciary_customers_actions WHERE judiciary_actions_id >= 10000;

-- الخطوة 8و: حذف جدول التعيين المؤقت
DROP TABLE IF EXISTS _id_map;

-- الخطوة 8ز: إعادة تعيين AUTO_INCREMENT
ALTER TABLE os_judiciary_actions AUTO_INCREMENT = 82;

-- ==========================================================================
-- إعادة تفعيل FK checks
-- ==========================================================================
SET FOREIGN_KEY_CHECKS = 1;
SET SQL_MODE = @OLD_SQL_MODE;

-- ==========================================================================
-- التحقق النهائي
-- ==========================================================================
SELECT id, name, action_type FROM os_judiciary_actions ORDER BY id;
