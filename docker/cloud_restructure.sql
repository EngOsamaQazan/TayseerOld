-- ==========================================================================
-- كود SQL مخصص لقاعدة البيانات السحابية (namaa_erp @ aqssat.co)
-- ==========================================================================
-- السحابة: 61 إجراء (IDs 1-63) → الهدف: 81 إجراء مرقّم (IDs 1-81)
-- حذف 6 إجراءات، إضافة 26 إجراء مفقود، إعادة تسمية + تصنيف + ترقيم
-- ==========================================================================

SET FOREIGN_KEY_CHECKS = 0;
SET @OLD_SQL_MODE = @@SQL_MODE;
SET SQL_MODE = 'NO_AUTO_VALUE_ON_ZERO';

-- ==========================================================================
-- المرحلة 0: إضافة عمود action_type
-- ==========================================================================
ALTER TABLE os_judiciary_actions
ADD COLUMN action_type ENUM('request','court_letter','judge_decision','party_petition','incoming_info')
NOT NULL DEFAULT 'request'
AFTER name;

-- ==========================================================================
-- المرحلة 1: إضافة 26 إجراء مفقود (بأرقام مؤقتة 101-126)
-- ==========================================================================
INSERT INTO os_judiciary_actions (id, name, action_type) VALUES
(101, 'أمر حبس لعدم الدفع', 'court_letter'),
(102, 'مذكرة إفراج للموقوفين', 'court_letter'),
(103, 'مذكرة تبليغ موعد جلسة تنفيذية', 'court_letter'),
(104, 'إخطار كفيل إستئناف صادر عن دائرة التنفيذ', 'court_letter'),
(105, 'مثابره بعد الحبس', 'request'),
(106, 'كتاب استفسار لعدم ورود اقتطاع', 'court_letter'),
(107, 'طلب رفع اشارة منع سفر', 'request'),
(108, 'طلب كف طلب عن المحكوم عليه', 'request'),
(109, 'طلب حجز الاموال المنقوله وغير المنقوله', 'request'),
(110, 'كتاب حجز على المكافئه', 'court_letter'),
(111, 'اخطار خاص بتجديد التنفيذ', 'court_letter'),
(112, 'حجز حصة شريك', 'judge_decision'),
(113, 'طلب اخطار في مكان العمل', 'request'),
(114, 'طلب تبليغ الكتروني', 'request'),
(115, 'طلب تخمين المركبه', 'request'),
(116, 'اعلان بيع مركبه بالمزاد العلني', 'court_letter'),
(117, 'طلب حجز حساب بنكي', 'request'),
(118, 'طلب حجز راتب', 'request'),
(119, 'كتاب إخطار بالحجز على أموال / مستحقات المدين المنقولة لدى الغير', 'court_letter'),
(120, 'كتاب كف الطلب عن شخص', 'court_letter'),
(121, 'طلب ادخال طرف بالقضيه', 'party_petition'),
(122, 'طلب اشراك اقتطاع', 'request'),
(123, 'طلب حجز منشاه', 'request'),
(124, 'الراتب لا يسمح', 'incoming_info'),
(125, 'طلب رفع حسم', 'request'),
(126, 'كتاب مخاطبة رسمية - جهات حكومية', 'court_letter');

-- ==========================================================================
-- المرحلة 2: نقل مراجع الإجراءات المحذوفة
-- ==========================================================================

-- طباعة مذكرة (16, 0 سجل) → مذكرة احضار صادره (9)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 9 WHERE judiciary_actions_id = 16;

-- تحريك قضية (24, 0 سجل) → طلب مثابرة منعا للترك (58)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 58 WHERE judiciary_actions_id = 24;

-- اسقاط الدعوى مكرر (33, 21 سجل) → اسقاط الدعوى الأصلي (15)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 15 WHERE judiciary_actions_id = 33;

-- نُفِّذت حبسا (35, 0 سجل) → أمر حبس لعدم الدفع (101 مؤقت)
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = 101 WHERE judiciary_actions_id = 35;

-- منتهي (40, 53 سجل) → حذف من سجلات القضايا
DELETE FROM os_judiciary_customers_actions WHERE judiciary_actions_id = 40;

-- متوفي (41, 4 سجلات) → حذف من سجلات القضايا
DELETE FROM os_judiciary_customers_actions WHERE judiciary_actions_id = 41;

-- ==========================================================================
-- المرحلة 3: حذف الإجراءات الملغاة من جدول الإجراءات
-- ==========================================================================
DELETE FROM os_judiciary_actions WHERE id IN (16, 24, 33, 35, 40, 41);

-- ==========================================================================
-- المرحلة 4: إعادة تسمية
-- ==========================================================================
UPDATE os_judiciary_actions SET name = 'طلب رد المبالغ المدفوعة' WHERE id = 63;

-- تنظيف المسافات الزائدة وأحرف Tab من جميع الأسماء
UPDATE os_judiciary_actions SET name = TRIM(BOTH '\t' FROM TRIM(name));

-- ==========================================================================
-- المرحلة 5: تصنيف أنواع الإجراءات للإجراءات الموجودة
-- ==========================================================================

-- معلومه وارده (incoming_info)
UPDATE os_judiciary_actions SET action_type = 'incoming_info' WHERE id IN (
    1,  -- تجهيز قضيه
    2,  -- امر قبض
    3,  -- دفع الرسم
    4,  -- تسجيل قضيه
    10, -- معمم لدى ادارة التنفيذ القضائي
    13, -- جاري الحسم
    17, -- نشر
    25, -- عدم ورود اقتطاعات
    32, -- مدفوع
    34  -- محبوس على ذمة قضايا اخرى
);

-- كتاب صادر عن المحكمة (court_letter)
UPDATE os_judiciary_actions SET action_type = 'court_letter' WHERE id IN (
    5,  -- اخطار صادر عن دائرة التنفيذ
    9,  -- مذكرة احضار صادره على محكوم عليه
    11, -- كف طلب صادر عن المحكوم عليه
    12, -- مذكرة منع سفر
    18, -- تبليغ اخبار حبس
    22, -- كتاب حسم من الراتب
    27, -- كتاب وضع اشارة الحجز على مركبة
    28, -- كتاب ضبط مركبة
    42, -- مذكرة رفع اشارة منع سفر
    43, -- كتاب كف الطلب عن مركبة
    45, -- كتاب رفع اشارة الحجز عن مركبة
    46, -- كتاب استفسار عن الحسابات البنكية
    47, -- كتاب استفسار لادارة الترخيص
    48, -- كتاب إلقاء الحجز على أموال لدى البنوك
    49, -- كتاب القاء حجز على سجل تجاري
    51, -- كتاب رفع اشارة الحجز عن سجل تجاري
    52, -- كتاب حجز على الأموال المنقوله وغير المنقوله
    53, -- كتاب رفع اشارة الحجز عن حساب بنكي
    56  -- كتاب رفع اشارة الحسم
);

-- قرار قاضي التنفيذ (judge_decision)
UPDATE os_judiciary_actions SET action_type = 'judge_decision' WHERE id IN (
    21, -- تسوية محكمة
    29, -- انكار توقيع
    30, -- ابطال التبليغات
    31, -- ابطال سند
    36, -- نقل تلقائي
    60  -- متروكة
);

-- استدعاء مقدم من أحد الأطراف (party_petition)
UPDATE os_judiciary_actions SET action_type = 'party_petition' WHERE id IN (
    14, -- استئناف
    59, -- استدعاء تجديد الدعوى
    63  -- طلب رد المبالغ المدفوعة
);

-- طلب إجرائي (request) — الباقي يبقى request وهو الافتراضي
-- يشمل: 6,7,8,15,19,20,23,26,39,44,50,54,55,57,58,61,62

-- ==========================================================================
-- المرحلة 6: إعادة ترقيم جميع الإجراءات من 1 إلى 81
-- ==========================================================================

-- الخطوة 6أ: نقل جميع IDs إلى نطاق مؤقت (+10000)
UPDATE os_judiciary_actions SET id = id + 10000;
UPDATE os_judiciary_customers_actions SET judiciary_actions_id = judiciary_actions_id + 10000;

-- الخطوة 6ب: إنشاء جدول التعيين المؤقت
DROP TABLE IF EXISTS _id_map;
CREATE TABLE _id_map (old_id INT PRIMARY KEY, new_id INT NOT NULL);

INSERT INTO _id_map (old_id, new_id) VALUES
-- cloud_old_id → new_id (الترقيم النهائي)
(1, 1),     -- تجهيز قضيه
(2, 2),     -- امر قبض
(3, 3),     -- دفع الرسم
(4, 4),     -- تسجيل قضيه
(5, 5),     -- اخطار صادر عن دائرة التنفيذ
(6, 6),     -- إعادة تبيلغ
(7, 7),     -- طلب حبس وجلب محكوم عليه
(8, 8),     -- طلب حسم راتب محكوم عليه
(9, 9),     -- مذكرة احضار صادره على محكوم عليه
(10, 10),   -- معمم لدى ادارة التنفيذ القضائي
(11, 11),   -- كف طلب صادر عن المحكوم عليه
(12, 12),   -- مذكرة منع سفر
(13, 13),   -- جاري الحسم
(14, 14),   -- استئناف
(15, 15),   -- اسقاط الدعوى
(17, 16),   -- نشر
(18, 17),   -- تبليغ اخبار حبس
(19, 18),   -- مصالحة
(20, 19),   -- طلب نشر
(21, 20),   -- تسوية محكمة
(22, 21),   -- كتاب حسم من الراتب
(23, 22),   -- ط.حجز مركبة
(25, 23),   -- عدم ورود اقتطاعات
(26, 24),   -- ط.ب.استئناف
(27, 25),   -- كتاب وضع اشارة الحجز على مركبة
(28, 26),   -- كتاب ضبط مركبة
(29, 27),   -- انكار توقيع
(30, 28),   -- ابطال التبليغات
(31, 29),   -- ابطال سند
(32, 30),   -- مدفوع
(34, 31),   -- محبوس على ذمة قضايا اخرى
(36, 32),   -- نقل تلقائي
(39, 33),   -- طلب اعادة تبليغ المحكوم عليه
(42, 34),   -- مذكرة رفع اشارة منع سفر
(43, 35),   -- كتاب كف الطلب عن مركبة
(44, 36),   -- طلب ضبط مركبه
(45, 37),   -- كتاب رفع اشارة الحجز عن مركبة
(46, 38),   -- كتاب استفسار عن الحسابات البنكية
(47, 39),   -- كتاب استفسار لادارة الترخيص
(48, 40),   -- كتاب إلقاء الحجز على أموال لدى البنوك
(49, 41),   -- كتاب القاء حجز على سجل تجاري
(50, 42),   -- طلب تحويل رصيد محجوز لدى الحساب البنكي
(51, 43),   -- كتاب رفع اشارة الحجز عن سجل تجاري
(52, 44),   -- كتاب حجز على الأموال المنقوله وغير المنقوله
(53, 45),   -- كتاب رفع اشارة الحجز عن حساب بنكي
(54, 46),   -- طلب حجز مكافأة نهاية خدمة
(55, 47),   -- طلب استفسار عدم ورود اقتطاع
(56, 48),   -- كتاب رفع اشارة الحسم
(57, 49),   -- طلب طرح مركبة للبيع بالمزاد العلني
(58, 50),   -- طلب مثابرة منعا للترك
(59, 51),   -- استدعاء تجديد الدعوى
(60, 52),   -- متروكة
(61, 53),   -- طلب وضع اليد على معرض تجاري محجوز
(62, 54),   -- طلب تحديد اقتطاع
(63, 55),   -- طلب رد المبالغ المدفوعة
(101, 56),  -- أمر حبس لعدم الدفع [جديد]
(102, 57),  -- مذكرة إفراج للموقوفين [جديد]
(103, 58),  -- مذكرة تبليغ موعد جلسة تنفيذية [جديد]
(104, 59),  -- إخطار كفيل إستئناف صادر عن دائرة التنفيذ [جديد]
(105, 60),  -- مثابره بعد الحبس [جديد]
(106, 61),  -- كتاب استفسار لعدم ورود اقتطاع [جديد]
(107, 62),  -- طلب رفع اشارة منع سفر [جديد]
(108, 63),  -- طلب كف طلب عن المحكوم عليه [جديد]
(109, 64),  -- طلب حجز الاموال المنقوله وغير المنقوله [جديد]
(110, 65),  -- كتاب حجز على المكافئه [جديد]
(111, 66),  -- اخطار خاص بتجديد التنفيذ [جديد]
(112, 67),  -- حجز حصة شريك [جديد]
(113, 68),  -- طلب اخطار في مكان العمل [جديد]
(114, 69),  -- طلب تبليغ الكتروني [جديد]
(115, 70),  -- طلب تخمين المركبه [جديد]
(116, 71),  -- اعلان بيع مركبه بالمزاد العلني [جديد]
(117, 72),  -- طلب حجز حساب بنكي [جديد]
(118, 73),  -- طلب حجز راتب [جديد]
(119, 74),  -- كتاب إخطار بالحجز على أموال / مستحقات المدين [جديد]
(120, 75),  -- كتاب كف الطلب عن شخص [جديد]
(121, 76),  -- طلب ادخال طرف بالقضيه [جديد]
(122, 77),  -- طلب اشراك اقتطاع [جديد]
(123, 78),  -- طلب حجز منشاه [جديد]
(124, 79),  -- الراتب لا يسمح [جديد]
(125, 80),  -- طلب رفع حسم [جديد]
(126, 81);  -- كتاب مخاطبة رسمية - جهات حكومية [جديد]

-- الخطوة 6ج: تطبيق التعيين على جدول الإجراءات
UPDATE os_judiciary_actions a
JOIN _id_map m ON a.id = m.old_id + 10000
SET a.id = m.new_id;

-- الخطوة 6د: تطبيق التعيين على جدول إجراءات العملاء
UPDATE os_judiciary_customers_actions c
JOIN _id_map m ON c.judiciary_actions_id = m.old_id + 10000
SET c.judiciary_actions_id = m.new_id;

-- الخطوة 6هـ: تنظيف أي مراجع يتيمة (احتياطياً)
DELETE FROM os_judiciary_customers_actions WHERE judiciary_actions_id >= 10000;

-- الخطوة 6و: حذف جدول التعيين المؤقت
DROP TABLE IF EXISTS _id_map;

-- الخطوة 6ز: إعادة تعيين AUTO_INCREMENT
ALTER TABLE os_judiciary_actions AUTO_INCREMENT = 82;

-- ==========================================================================
-- إعادة تفعيل FK checks
-- ==========================================================================
SET FOREIGN_KEY_CHECKS = 1;
SET SQL_MODE = @OLD_SQL_MODE;

-- ==========================================================================
-- التحقق النهائي
-- ==========================================================================
SELECT id, name, action_type FROM os_judiciary_actions ORDER BY id;
